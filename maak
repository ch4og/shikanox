#!/usr/bin/env -S GUILE_AUTO_COMPILE=0 guix shell maak -- env -S GUILE_AUTO_COMPILE=0 maak -f
;; -*- mode: scheme -*-
;; SPDX-FileCopyrightText: 2026 Nikita Mitasov <me@ch4og.com>
;; SPDX-License-Identifier: GPL-3.0-or-later
!#

(define-module (maak)
  #:declarative? #t
  #:use-module (maak maak)
  #:use-module (ice-9 match)
  #:use-module (ice-9 ftw))

(define config-root
  (dirname (canonicalize-path (current-filename))))

(add-to-load-path config-root)

(define (fmt)
  "Format code"
  ($ `("find" ,(string-append config-root "/shika") "-type f -name '*.scm'"
       "-exec emacs --batch {} --eval '(progn (indent-region (point-min) (point-max)) (save-buffer))' \\;")
     #:verbose? #t))

(define (default)
  ($ `(,(current-filename) "--list")
     #:verbose? #t))

(define (update)
  "Update packages"
  (for-each (lambda (name)
              (format #t "Refreshing ~a~%" name)
              ($ `("guix refresh" "-L"
                   ,config-root "-u"
                   ,(string-append "--select='module:(shika packages " name ")'"))
                 #:verbose? #t))
            (map (lambda (f)
                   (substring f 0
                              (- (string-length f) 4)))
                 (filter (lambda (f)
                           (string-suffix? ".scm" f))
                         (scandir (string-append config-root
                                                 "/shika/packages"))))))
