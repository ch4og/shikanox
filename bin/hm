#!/usr/bin/env -S guix shell guile -- guile --no-auto-compile
;; -*- mode: scheme -*-
;; SPDX-FileCopyrightText: 2025 Nikita Mitasov <me@ch4og.com>
;; SPDX-License-Identifier: GPL-3.0-or-later
!#

(define repo-nix-root
  (string-append (dirname (dirname (canonicalize-path (current-filename)))) "/nix"))

(define repo-nix-hm
  (string-append repo-nix-root "/hm"))

(use-modules (ice-9 match)
             (ice-9 ftw))

(define (run-format)
  (system (string-join `("cd" ,repo-nix-hm "&&" "nix fmt .") " ")))

(define (run-switch extra-args)
  (system (string-join (append `("cd" ,repo-nix-hm "&&" "nix run . -- switch --flake .") extra-args) " ")))

(define (run-update extra-args)
  (system (string-join (append `("cd" ,repo-nix-hm "&&" "nix flake update") extra-args) " ")))

(define (usage command)
  (display (string-append "Usage: " command " COMMAND [args...]\n\n"))
  (display "Commands:\n")
  (display "  update  [args...]   - update inputs in lockfile\n")
  (display "  switch  [args...]   - reconfigure and switch\n")
  (display "  format              - format code with alejandra\n"))

(define (selection cmd)
  (match (cdr cmd)
    (("update" . rest) (run-update rest))
    (("switch" . rest) (run-switch rest))
    (("format") (run-format))
    (_ (usage (car cmd)) (exit 1))))

(selection (command-line))
